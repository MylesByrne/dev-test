<!-- app/views/cars/new.html.erb -->
<h1>New Car</h1>
<%= render "form", car: @car, makes: @makes, models: @models, years: @years %>

<script>
function initCarForm() {
  const makeSel  = document.getElementById('car_make_select');
  const modelSel = document.getElementById('car_model_select');
  const yearSel  = document.getElementById('car_year_select');
  if (!makeSel || !modelSel || !yearSel) return;

  if (makeSel.dataset.bound === 'true') return;
  makeSel.dataset.bound = 'true';

  function loadModels(makeId, preselectId = null) {
    if (!makeId) {
      modelSel.innerHTML = '<option value="">Select Model</option>';
      yearSel.innerHTML  = '<option value="">Select Year</option>';
      modelSel.disabled = false;
      yearSel.disabled  = false;
      return;
    }
    modelSel.innerHTML = '<option value="">Loading...</option>';
    yearSel.innerHTML  = '<option value="">Select Year</option>';
    modelSel.disabled = true;
    yearSel.disabled  = true;

    fetch('/car_models/for_make/' + makeId, { headers: { 'Accept': 'application/json' } })
      .then(r => r.json())
      .then(models => {
        modelSel.innerHTML = '<option value="">Select Model</option>';
        models.forEach(m => {
          const o = document.createElement('option');
          o.value = m.id;
          o.text  = m.name;
          if (preselectId && String(preselectId) === String(m.id)) o.selected = true;
          modelSel.appendChild(o);
        });
        modelSel.disabled = false;

        // If we preselected a model (edit/validation re-render), load years too
        if (preselectId) {
          loadYears(makeId, preselectId, yearSel.value || null);
        } else {
          yearSel.disabled = false;
        }
      })
      .catch(() => {
        modelSel.innerHTML = '<option value="">Select Model</option>';
        modelSel.disabled = false;
        yearSel.disabled  = false;
      });
  }

  function loadYears(makeId, modelId, preselectId = null) {
    if (!makeId || !modelId) {
      yearSel.innerHTML = '<option value="">Select Year</option>';
      yearSel.disabled  = false;
      return;
    }
    yearSel.innerHTML = '<option value="">Loading...</option>';
    yearSel.disabled  = true;

    fetch(`/years/for_model/${makeId}/${modelId}`, { headers: { 'Accept': 'application/json' } })
      .then(r => r.json())
      .then(years => {
        yearSel.innerHTML = '<option value="">Select Year</option>';
        years.forEach(y => {
          const o = document.createElement('option');
          o.value = y.id;
          o.text  = y.year;
          if (preselectId && String(preselectId) === String(y.id)) o.selected = true;
          yearSel.appendChild(o);
        });
        yearSel.disabled = false;
      })
      .catch(() => {
        yearSel.innerHTML = '<option value="">Select Year</option>';
        yearSel.disabled  = false;
      });
  }

  makeSel.onchange  = e => loadModels(e.target.value);
  modelSel.onchange = e => loadYears(makeSel.value, e.target.value);

  if (makeSel.value && !makeSel.dataset.autopopulated) {
    const currentModelId = modelSel.value || null;
    const currentYearId  = yearSel.value  || null;
    loadModels(makeSel.value, currentModelId);
    if (currentModelId) loadYears(makeSel.value, currentModelId, currentYearId);
    makeSel.dataset.autopopulated = 'true';
  }
}

document.addEventListener('turbo:load',   initCarForm);
document.addEventListener('DOMContentLoaded', initCarForm);
</script>


<p><%= link_to "Back", cars_path %></p>
