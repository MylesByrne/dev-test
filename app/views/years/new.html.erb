<!-- app/views/years/new.html.erb -->
<h1>New Year</h1>

<%= render "form", year: @year, makes: @makes, models: @models %>

<script>
function initYearForm() {
  const makeSelect  = document.getElementById('year_make_select');
  const modelSelect = document.getElementById('year_model_select');
  if (!makeSelect || !modelSelect) return;

  if (makeSelect.dataset.bound === 'true') return;
  makeSelect.dataset.bound = 'true';

  function populateModels(makeId) {
    modelSelect.innerHTML = '<option value="">Loading...</option>';
    modelSelect.disabled = true;

    if (!makeId) {
      modelSelect.innerHTML = '<option value="">Select Model</option>';
      modelSelect.disabled = false;
      return;
    }

    fetch('/car_models/for_make/' + makeId, { headers: { 'Accept': 'application/json' } })
      .then(res => res.json())
      .then(models => {
        modelSelect.innerHTML = '<option value="">Select Model</option>';
        models.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id; opt.text = m.name;
          modelSelect.appendChild(opt);
        });
        modelSelect.disabled = false;
      })
      .catch(() => {
        modelSelect.innerHTML = '<option value="">Select Model</option>';
        modelSelect.disabled = false;
      });
  }

  makeSelect.onchange = function () {
    populateModels(this.value);
  };

  if (makeSelect.value && modelSelect.dataset.populated !== 'true') {
    populateModels(makeSelect.value);
    modelSelect.dataset.populated = 'true';
  }
}

document.addEventListener('turbo:load', initYearForm);
document.addEventListener('DOMContentLoaded', initYearForm);
</script>

<p><%= link_to "Back", years_path %></p>
